## 网易云信音乐教学解决方案 iOS 端实现说明
### 一）终端整体业务逻辑简介
#### 1. 解决方案概述
音乐教学解决方案旨在展现音乐教学场景下的音视频 SDK 能力，并为开发者提供可借鉴和集成的音乐教学 Demo。
该解决方案集成了网易云信互动直播和互动白板等多种能力，结合网易云信最新推出的高清音乐模式，最大限度地满足音乐教学场景中对音质的追求，同时实现了师生实时互动、曲谱标注、视频互动等功能，提升了课程质量。
#### 2. 解决方案角色简介
音乐教学 Demo 的教学场景里分为两个角色`学生`和`老师`。学生可以主动预约课程，通过服务器请求分配可用房间号来创建一个教室，在课程中可看到老师同步在乐谱白板上的内容，并与老师进行语音或视频交流；老师可进入创建的课程房间，在上课过程中可在白板上翻页和标注，并选择单向观看学生上课视频或与学生进行双向语音或者视频交流。
#### 3. 注意事项
该解决方案使用了云信即时通信、音视频通话和互动白板全套 SDK，因此在使用本解决方案之前请务必了解

 * [IM即时通讯](http://dev.netease.im/docs/product/IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/SDK%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/iOS%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5?kw=%E8%87%AA%E5%AE%9A%E4%B9%89%E9%80%9A%E7%9F%A5&pg=1&pid=0#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5) 的自定义通知能力
 
 * [音视频通话](http://dev.netease.im/docs/product/%E9%9F%B3%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D/SDK%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/iOS%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/%E9%9B%86%E6%88%90%E6%96%B9%E5%BC%8F) 的多人会议能力

 * [互动白板](http://dev.netease.im/docs/product/%E4%BA%92%E5%8A%A8%E7%99%BD%E6%9D%BF/SDK%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/iOS%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/%E6%A6%82%E8%A6%81%E4%BB%8B%E7%BB%8D) 的多人实时会话能力

### 二）音乐教学解决方案重难点逻辑实现
#### 1. 创建以及进入教室
业务逻辑中`教室`的概念与一个多人会议的`房间`对等，该房间由房间号唯一标识。该业务房间由音视频服务器创建，客户端通过请求向应用服务器获取房间号，然后预约房间，具体请求接口详情见下节业务层说明。
老师端登录后，预约该服务器创建的房间，学生端可加入该房间与老师互动。在老师点击下课后告知服务器进行房间的回收销毁，若老师未预约该房间，学生端不能进入。

#### 2. 师生语音和视频通话
解决方案提供三种不同的语音/视频模式：
1）双向语音，老师和学生仅进行语音通话（语音与白板互相独立，不影响对方功能）
2）单向视频，老师可以看到学生视频，学生仅可以进行语音与老师通话
3）双向视频，老师学生可以进行双向视频通话，隐藏白板界面

#### 3.白板绘制
老师创建白板通道后学生加入，即可进行互动。
音乐教学场景，老师通过白板上的乐谱标注，实现实时教学互动，具体互动协议： 
1. type 类型为 1，2，3 的起始点，移动点，结束点新增 `pageIndex` 信息。
2. type 类型为 6 的清空，作为按页清空而存在。需要全部清空时，可发送 type 类型为 10 的同步准备。
标注操作主要通过绘制笔画模型、绘制指令模型和界面渲染构成，具体可见业务介绍章节。

### 三）源码导读
#### 1. 工程说明
音乐教学 Demo 基于以下开发

*  项目依赖管理 [CocoaPods](https://cocoapods.org/)，版本 1.3.1
*  网易云信完整版本 [NIMSDK](http://netease.im/im-sdk-demo), 版本 5.0.1
*  CocoaLumberjack 日志库 [CocoaLumberjack](https://github.com/CocoaLumberjack/CocoaLumberjack) 版本 3.4.1
*  网络连接状态检测库 [RealReachability](https://github.com/dustturtle/RealReachability) 版本 1.1.9
*  加载状态 UI [SVProgressHUD](https://github.com/SVProgressHUD/SVProgressHUD) 版本 2.2.2
*  弹出提示 UI [Toast](https://github.com/scalessec/Toast) 版本 4.0.0
*  SDWebImage 图片加载库 [SDWebImage](https://github.com/rs/SDWebImage) 版本 4.3.3

#### 2. 工程结构

工程结构截图如下
**文件目录图**
![](http://yx-web.nos.netease.com/webdoc/default/iOS/fileIndex.png) 

**工程图**
![](http://yx-web.nos.netease.com/webdoc/default/iOS/workspace.png) 

```
└── NIMMusicTeach/Class                        # 音乐教学工程
    ├── Service                                # 业务服务层
    │   └── Network                            # 网络层
    ├── Category                               # Category 工具
    ├── Manager                                # 业务管理层
    ├── Model                                  # 数据模型层
    ├── UI                                     # UI 界面交互层
    └── Util                                   # 一些第三方工具
```
 
* UI 层为界面层，主要包括登录界面、预约课程界面和房间互动界面，具体交互逻辑后面介绍。
* Manager 层为白板互通管理层，主要负责白板的互通与绘制指令约定
* Service 层为业务服务层，主要负责具体的业务逻辑，目前主要有三个业务：登录业务、老师查询预约课程、下课；学生查询课程以及预约课程等接口请求逻辑
* Network 为网络层，主要负责和业务服务器交互。
       
#### 3. 网络层介绍
网络层单例 `NTESNetwork`，通过接口

```objc
- (void)postNetworkTask:(id<NTESNetworkTask>)task
             completion:(void(^)(NSError *error, id jsonObject))completion
```

发起网络请求，网络请求被封装在实现了 `NTESNetworkTask` 协议的 task 对象中。
目前有如下网络请求：

**学生相关接口**

* 注册接口 NTESRegistTask
    * 请求说明

	    ```
	    POST http://${Host}/user/reg HTTP/1.1
	    Content-Type: application/x-www-form-urlencoded;charset=utf-8
	    ```
    * 参数列表

		| 名称              | 类型             | 说明                 | 必填
		|----------------------|--------------------|--------|-----|
		| accid  | String  | 提供初始化，注册 | 是 |
		| nickname  | String  | 提供初始化，注册 | 是 |
    	| password  | String  | 提供初始化，注册| 是 |
    	
    * 返回说明
    
       | 参数              | 类型             | 说明                 
		|----------------------|--------------------|--------|
		| code  | int  | 状态码 |
		| msg | String  | 错误信息|
		| data | String  | 账号信息 | 
    	
* 账号身份校验

    * 请求说明
      
    ```
    POST http://${Host}/user/check HTTP/1.1
	Content-Type: application/x-www-form-urlencoded;charset=utf-8
    ```
    * 参数列表

		| 名称              | 类型             | 说明                 | 必填
		|----------------------|--------------------|--------|-----|
		| accid  | String  | 提供初始化，注册 | 是 |
		| nickname  | String  | 提供初始化，注册 | 是 |
    	| password  | String  | 提供初始化，注册| 是 |
    	
    * 返回说明
    
       | 参数              | 类型             | 说明                 
		|----------------------|--------------------|--------|
		| code  | int  | 状态码 |
		| msg | String  | 错误信息|
		| data | String  | 账号和身份信息 | 

* 预约课程
    * 请求说明
      
    ```
    POST http://${Host}/room/create HTTP/1.1
	Content-Type: application/x-www-form-urlencoded;charset=utf-8
    ```
    * 参数列表

		| 名称              | 类型             | 说明                 | 必填
		|----------------------|--------------------|--------|-----|
		| accid  | String  | 提供查询账号 | 是 |
		
    * 返回说明
    
       | 参数              | 类型             | 说明                 
		|----------------------|--------------------|--------|
		| code  | int  | 状态码 |
		| msg | String  | 错误信息|
		| data | String  | 成功预约课程后的老师学生信息 | 
		
* 查询课程
    * 请求说明
      
    ```
    POST http://${Host}/room/query HTTP/1.1
	Content-Type: application/x-www-form-urlencoded;charset=utf-8
    ```
    	
    * 参数列表

		| 名称              | 类型             | 说明                 | 必填
		|----------------------|--------------------|--------|-----|
		| accid  | String  | 提供查询账号 | 是 |

    * 返回说明
    
       | 参数              | 类型             | 说明                 
		|----------------------|--------------------|--------|
		| code  | int  | 状态码 |
		| msg | String  | 错误信息|
		| data | String  | 成功预约课程后的老师学生信息 | 

**老师相关**

* 查询课程
    * 请求说明
    
	   ```
    POST http://${Host}/teacher/room/query HTTP/1.1
	  Content-Type: application/x-www-form-urlencoded;charset=utf-8
    ```
    * 参数列表

		| 名称              | 类型             | 说明                 | 必填
		|----------------------|--------------------|--------|-----|
		| accid  | String  | 提供查询账号 | 是 |

    * 返回说明
    
       | 参数              | 类型             | 说明                 
		|----------------------|--------------------|--------|
		| code  | int  | 状态码 |
		| msg | String  | 错误信息|
		| data | String  | 成功预约课程后的学生信息 | 
		
* 下课
    
    * 请求说明
    
	   ```
    POST http://${Host}/teacher/room/close HTTP/1.1
	  Content-Type: application/x-www-form-urlencoded;charset=utf-8
    ```
    * 参数列表

		| 名称              | 类型             | 说明                 | 必填
		|----------------------|--------------------|--------|-----|
		| accid  | String  | 提供老师账号 | 是 |
		| roomid  | String  | 提供下课房间号 | 是 |


    * 返回说明
    
       | 参数              | 类型             | 说明                 
		|----------------------|--------------------|--------|
		| code  | int  | 状态码 |
		| msg | String  | 错误信息|
	老师端下课后需要向学生发点对点的自定义广播通知，通过 NIMCustomSystemNotification 来进行发送。具体协议约定如下，具体代码实现可见 `NTES` 
	
    ```
{"command":1, "data":{"roomId": "123"}} //123是任意房间号示例
```
		
#### 4. 业务层介绍
业务层主要负责两方面工作，一是与应用服务器的交互，一是与音视频 SDK 的交互；与应用服务器的交互通过调用网络层接口返回的数据完成相应的业务逻辑。目前所有的业务要分老师端和学生端来介绍。

* **1. 应用服务器相关业务**
`学生端`主要的业务有：

* 注册、登录业务 NTESLoginService
注册、登录业务主要完成登录步骤：
1）若无账号，则调用网络层注册接口，向服务器发送注册请求
2）调用 云信 IM SDK 登录云信服务器
3）回调登录成功结果

* 预约、查询课程业务 NTESStudentService
1）学生端登录，首先会查询是否已经预约了课程，若已经预约课程，则返回对应的老师账号信息和对应的房间信息
2）如果没有预约课程，可以通过预定课程接口，进行课程的预约

`老师端`主要的业务有：

* 登录业务 NTESLoginService 

老师端的账号由服务器创建好，在学生成功预约课程时，随教室的信息一起返回，然后提供给老师端登录 IM 云信服务器。

* 课程查询、下课业务 NTESTeacherService

1）老师端登录后会查询是否已经有学生预约了自己的课程，若已经预约，则返回教室相关信息，以供音视频房间的预约。
2）老师在上课结束后，需要进行下课操作，同样需要一个接口进行这个操作。


* **2.多人会议 SDK 相关业务**
多人会议在该解决方案里由应用服务器分配房间号 roomid，并以 roomid 作为房间的唯一标识。教室的预约和加入在前面已经介绍，在进入房间后，本解决方案使用了 SDK 静音、视频通话、网络监测等能力。

* **3.白板相关业务**

白板的绘制包括操作端的绘制以及接收端的绘制，因此分三个部分介绍，分别为绘制笔画模型、绘制指令模型和界面渲染。

1）绘制笔画模型
点组成线，这里组成一个点由 x、y 坐标，颜色以及颜色和页码组成。具体实现见 `NTESWhiteboardPoint`。
**点 (x，y）**:  浮点型的**相对**坐标，值为相对于画板的长宽，例如下图的白板示意中 x 点的坐标为 x= 2/6 = 0.3333 y = 3/4 = 0.75 

| o | o | o | o | o | o |
|---|---|---|---|---|---|
| o | o | o | o | o | o |
| o | x | o | o | o | o |
| o | o | o | o | o | o |

**rgb**：整型的颜色值，例如一个颜色的RGB是 0xF3F6F9，rgb 表示为15988473，因此上图的坐标点如果是一个`移动点`，那这这个点的`命令`为：

```
	2:0.3333,0.75,15988473
```
2）绘制指令
绘制指令为一个字符串类型，具体分为 `type`和`value`两部分，根据操作制定了如下指令：

|类型     | type |   value,value,value,…|
|---------|-----|----------|
|起始点    | 1   |   x,y,rgb |
|移动点    | 2   |   x,y,rgb |
|结束点    | 3    |  x,y,rgb |
|上一步    | 4     |  |
|包序号    | 5   |   id |
|清空      |   6 |     |
|清空响应   |  7  |  |
|同步请求   |  8  |  |
|同步      |  9  |    uid,end |
|同步准备   |  10  |  |
|同步准备响应|  11 |  |
|标记		|  12 | x,y,rgb |
|标记结束	|  13 |  |
|文档分享	|  14 | docId,pageCount,currentPage,type |

说明：
**清空**：只能主播发，发广播包；主播清空所有笔画，同时发该命令，非主播收到该命令后，清空所有笔画；

**清空响应**：参与者收到清空命令后发`清空响应`广播包；其他人收到该响应后，清空该参与者的笔画。该步骤用来避免清空过程中同时有人在画图可能会导致的数据不一致

**同步请求**: 非主播加入多人实时会话成功以后，发送该命令给主播

**同步准备**: 主播B多人白板登录成功（包含断网重新登录成功）后，发送该指令给所有其他人，然后再发`同步`。其他人收到该消息后清空本地所有数据

**同步准备响应**: 非主播收到`同步准备`后，回该消息给主播。该消息用于适配服务端录制回放功能，主播收到以后无需处理

**同步**：1. 主播B收到A`同步请求`后，主播B把所有的用户ABCD的笔画的数据单播发送给用户A，每个用户的数据单独通过该协议发送；、

end=1表示该用户的数据发完了，例如C的数据可以一次发完：
```
	8:uid_C,1;1:x,y,rgb;2:x,y,rgb;…;3:x,y,rgb;
```

end=0表示没发完，后面还有数据。例如C的数据量太大，超过SDK接口的发送限制，可以分多条发送，比如分3个指令发送：

指令1, end=0

```
	8:uid_C,0;1:x,y,rgb;2:x,y,rgb;…;3:x,y,rgb;
```
指令2, end=0

```
	8:uid_C,0;1:x,y,rgb;2:x,y,rgb;…;3:x,y,rgb;
```
包3, end=1

```
	8:uid_C,1;1:x,y,rgb;2:x,y,rgb;…;3:x,y,rgb;
```

A在收完C所有的数据以后，清空C当前的数据，用同步的数据代替之。

绘制指令的发送是通过调用 SDK 发送或者从SDK接收到的一条多人实时会话数据，一个指令是一个字符串，指令之间用分号隔开。

```
命令1;命令2;命令3;
```
【注】这些指令的实现可参考代码 `NTESWhiteboardCommand` 实现。

3）界面渲染简介
在接收到指令并渲染的过程主要通过 `NTESWhiteboardCmdHandler` 和`NTESWhiteboardLines` 类去完成。前者处理各种接收到的指令，后者渲染界面。
界面渲染主要需要注意渲染的时机，以防笔画不同步等问题。
老师作为主播，收到进入房间回调会发：
a.白板同步准备指令
b.页码同步指令
c.笔画同步指令
学生端进入房间后：
a.清空自己界面
b.发出同步请求指令
c.接收到同步笔画
d.接收到页码同步
由此完成老师和学生端同步。
【注】具体实现可见 Demo  `NTESClassroomViewController` 相关接口。

#### 5. 参数配置

在 `NTESSolutionConfig.m` 文件中，进行服务器地址、appKey 配置。

```objc
//云信 APP KEY
_appKey  = @"XXX";

//Demo 应用服务器地址
_appHost = @"http://xxx"
```

